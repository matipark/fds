-- Loop through the dates

use sdfdemo

IF OBJECT_ID('tempdb.dbo.#table', 'U') IS NOT NULL
  DROP TABLE #table; 

CREATE TABLE #table(factset_entity_id char(8) not null, entity_proper_name varchar(200) not null, turnover_label varchar(200) null, style varchar(200) null, objectives varchar(200) null, fsym_id char(8) not null, proper_name varchar(200) not null, exchange varchar(40) null, country_desc varchar(24) null, l1_name varchar(200) null, l2_name varchar(200) null, l3_name varchar(200) null, l4_name varchar(200) null, position float null, mkt_val float null, report_date date null, as_of_date date not null, primary key (factset_entity_id, fsym_id, as_of_date))


declare @hldrid varchar(20)
declare @fundname varchar(20)
declare @pricedate date
declare @histdate date
declare @daysback integer
declare @daysahead integer
set @hldrid = '06HJ8Y-E'
set @fundname = 'ff_fidelity_test'


--'002FYS-E' vanguard
--'002HJD-E' blackrock
--'06HJ8Y-E' fidelity
--'000WX2-E' state_st
--'00G7QL-E' UBS
--'0035K2-E' JPM


set @histdate = '2008-01-01' -- SET PARAMETER
--as of date
set @daysback = -730
--number of days prior to the @histdate that the holdings would be considered valid
set @daysahead = 0
--number of days after the @histdate that the holdings would be condidered valid
set @pricedate = (select max(price_date) from own_v5.own_sec_prices
where price_date between dateadd(dd,@daysback,@histdate) and dateadd(dd,@daysahead,@histdate))


WHILE @histdate <= '2021-05-01' -- SET PARAMETER


--Looping dates to populate target table

BEGIN

--Cleaning up the table if it already has any data

IF EXISTS(SELECT * FROM [sdfdemo_scratch].[INFORMATION_SCHEMA].[TABLES] WHERE TABLE_NAME in(@fundname))


Exec ('TRUNCATE TABLE sdfdemo_scratch.dbo.' + @fundname)


ELSE


Exec ('CREATE TABLE sdfdemo_scratch.dbo.' + @fundname + '(factset_entity_id char(8) not null, entity_proper_name varchar(200) not null, turnover_label varchar(200) null, style varchar(200) null, objectives varchar(200) null, fsym_id char(8) not null, proper_name varchar(200) not null, exchange varchar(40) null, country_desc varchar(24) null, l1_name varchar(200) null, l2_name varchar(200) null, l3_name varchar(200) null, l4_name varchar(200) null, position float null, mkt_val float null, report_date date null, as_of_date date not null, primary key (factset_entity_id, fsym_id, as_of_date))')

--insert data into temporary table then copy to target table

insert into #table


select --top 100

ent.factset_entity_id
, ent.entity_proper_name
, f.turnover_label
, f.style
, map.invt_obj_specialization_desc
, h.fsym_id
, sym.proper_name
, coe.fref_listing_exchange exchange
, cou.country_desc
, st.l1_name
, st.l2_name
, st.l3_name
, st.l4_name
, h.adj_holding position
, h.adj_holding * p.adj_price mkt_val
, h.report_date
, @histdate as_of_date
from own_v5.own_fund_detail h
join own_v5.own_ent_funds f on f.factset_fund_id = h.factset_fund_id and f.active_flag = 1
join ent_v1.ent_entity_structure e on f.factset_fund_id = e.factset_entity_id
join

(
select max(fh.report_date) as max_date, fh.factset_fund_id
from own_v5.own_ent_fund_filing_hist fh
where fh.report_date between dateadd(dd,@daysback,@histdate) and dateadd(dd,@daysahead,@histdate)
group by fh.factset_fund_id
) md on md.max_date = h.report_date and md.factset_fund_id = h.factset_fund_id


join sym_v1.sym_entity ent on f.Factset_Fund_ID = ent.factset_entity_id
join sym_v1.sym_coverage sym on sym.fsym_id = h.fsym_id
join sym_v1.sym_coverage coe on coe.fsym_id = sym.fsym_primary_listing_id
join sym_v1.sym_sec_entity en on sym.fsym_id = en.fsym_id
join sym_v1.sym_entity en2 on en.factset_entity_id = en2.factset_entity_id
join ref_v2.country_map cou on cou.iso_country = en2.iso_country
join rbics_v1.rbics_entity_focus rb on rb.factset_entity_id = en.factset_entity_id
join rbics_v1.rbics_structure st on rb.l6_id = st.l6_id
join own_v5.own_sec_prices p on p.fsym_id = h.fsym_id and p.price_date = @pricedate
join own_v5.own_ent_fund_objectives obj on ent.factset_entity_id = obj.factset_fund_id
join ref_v2.invt_obj_specialization_map map on obj.invt_obj_specialization_code = map.invt_obj_specialization_code
where e.factset_ultimate_parent_entity_id = @hldrid
and h.adj_holding is not null and rb.end_date is null and st.end_date is null

SET @histdate = DATEADD(MONTH, 1, @histdate)

EXEC ('insert into sdfdemo_scratch.dbo.' + @fundname + '(factset_entity_id, entity_proper_name, turnover_label, style, objectives, fsym_id, proper_name, exchange, country_desc, l1_name, l2_name, l3_name, l4_name, position, mkt_val, report_date, as_of_date) select * from #table')

END

EXEC ('select * from sdfdemo_scratch.dbo.' + @fundname)




===============



-- pos_chg/neg_chg are funds that changed their position 
-- total_changed is total number of funds that changed position
-- total is the total number of funds, including those without changes
-- pct_changed is the percentage of funds that changed position
-- net_chg is pos_chg - neg_chg


DECLARE @manager AS NVARCHAR(20)= 'vanguard'

select case when style in ('Growth','Aggressive Growth') then 'Growth' when style in ('Value','Deep Value') then 'Value' else style end as style_agg, as_of_date, sum(case when changes_made > 0 then 1 else 0 end) as pos_chg, sum(case when changes_made < 0 then 1 else 0 end) as neg_chg, sum(case when changes_made <> 0 then 1 else 0 end) as total_changed, count(changes_made) as total, (sum(case when changes_made <> 0 then 1 else 0 end)*1. / count(changes_made)) * 100 as pct_changed, sum(case when changes_made > 0 then 1 else 0 end)-sum(case when changes_made < 0 then 1 else 0 end) as net_chg
from [sdfdemo_scratch].[dbo].[ff_agg]
where manager = @manager
group by case when style in ('Growth','Aggressive Growth') then 'Growth' when style in ('Value','Deep Value') then 'Value' else style end, as_of_date
order by as_of_date, style_agg

select case when style in ('Growth','Aggressive Growth') then 'Growth' when style in ('Value','Deep Value') then 'Value' else style end as style_agg, as_of_date, sum(case when changes_made > 0 then 1 else 0 end) as pos_chg, sum(case when changes_made < 0 then 1 else 0 end) as neg_chg, sum(case when changes_made <> 0 then 1 else 0 end) as total_changed, count(changes_made) as total, (sum(case when changes_made <> 0 then 1 else 0 end)*1. / count(changes_made)) * 100 as pct_changed, sum(case when changes_made > 0 then 1 else 0 end)-sum(case when changes_made < 0 then 1 else 0 end) as net_chg
from [sdfdemo_scratch].[dbo].[ff_style]
where manager = @manager
group by case when style in ('Growth','Aggressive Growth') then 'Growth' when style in ('Value','Deep Value') then 'Value' else style end, as_of_date
order by as_of_date, style_agg



use sdfdemo_scratch

CREATE TABLE sdfdemo_scratch.dbo.ff_style_test(manager varchar(20), factset_entity_id char(8) not null, entity_proper_name varchar(200) not null, style varchar(200) null, as_of_date date not null, position float null, changes_made float null, primary key (factset_entity_id, as_of_date)) -- creating table


insert into sdfdemo_scratch.dbo.ff_style_test -- insert into table

-- need to change the name of the fund and name of the source table

select * from ( 

SELECT 'vanguard' as manager, [factset_entity_id], [entity_proper_name], [style], as_of_date, sum(position) as position, ISNULL(((sum(position)*1./ NULLIF(lag(sum(position), 1) OVER (PARTITION BY entity_proper_name ORDER BY as_of_date asc),0))- 1) * 100, 100) as changes_made

FROM [sdfdemo_scratch].[dbo].[ff_vanguard]

group by [factset_entity_id], [entity_proper_name], [style], as_of_date) a

where a.as_of_date <> '2008-01-01' -- excluding the first date as it will be NULL



================


/****** Script for SelectTopNRows command from SSMS  ******/
SELECT TOP (1000) *
  FROM [sdfdemo_scratch].[dbo].[ff_style]
  where as_of_date = '2021-01-01' and manager = 'vanguard' and changes_made > 0

  SELECT TOP (1000) *
  FROM [sdfdemo_scratch].[dbo].[ff_style_test]
  where as_of_date = '2021-02-01' and manager = 'vanguard' and changes_made > 0


SELECT [factset_entity_id], [entity_proper_name], [style], as_of_date, sum(position) as position
FROM [sdfdemo_scratch].[dbo].[ff_vanguard]
where as_of_date = '2021-02-01'

group by [factset_entity_id], [entity_proper_name], [style], as_of_date



  /****** Script for SelectTopNRows command from SSMS  ******/
SELECT TOP (1000) manager, factset_entity_id, entity_proper_name, style, as_of_date, sum(position), avg(changes_made)
  FROM [sdfdemo_scratch].[dbo].[ff_agg]
  where as_of_date = '2021-05-01' and changes_made > 0
  group by manager, factset_entity_id, entity_proper_name, style, as_of_date

