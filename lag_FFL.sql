
WITH lag AS (SELECT  ticker_region, q.fsym_id, proper_name, date, ff_fiscal_date, ff_fp_ind_code


,(SELECT MAX(c_lag) FROM (VALUES(ff_source_bs_date), (ff_source_is_date), (ff_source_cf_date), (ff_eps_rpt_date)) AS value(c_lag)) AS custom_lag --latest date from the four reported dates
                 

,CASE --in case the dynamic lagging does not work
    WHEN ff_fp_ind_code = 4 --when it's annual report lag 90 else 45
    THEN 90
    ELSE 45
END AS standard_lag_count


FROM sym_v1.sym_ticker_region AS tr
JOIN ff_v3.ff_sec_map AS fm
ON fm.fsym_id = tr.fsym_id
JOIN sym_v1.sym_coverage AS cov
ON cov.fsym_id = tr.fsym_id
JOIN ff_v3.ff_basic_qf AS q
ON q.fsym_id = fm.fsym_company_id)




SELECT

ticker_region, proper_name, p.fsym_id, p.p_date, lag.date, lag.ff_fiscal_date, lag.ff_fp_ind_code, standard_lag_count, DATEADD(DAY, standard_lag_count, ISNULL(lag.ff_fiscal_date, lag.date)) AS standard_lag



,


CASE

    WHEN DATEDIFF(DAY, ISNULL(lag.ff_fiscal_date, lag.date), custom_lag)
    > standard_lag_count
        OR DATEDIFF(DAY, ISNULL(lag.ff_fiscal_date, lag.date),
        custom_lag) = 0 
    THEN DATEADD(DAY, standard_lag_count, ISNULL(lag.ff_fiscal_date,
    lag.date)) 
    ELSE custom_lag

 END AS pit_date -- If custom_lag is later than standard_lag, then use standard_lag. Otherwise use custom_lag. 




, qf.ff_eps_rpt_date, qf.ff_source_is_date, qf.ff_source_bs_date, qf.ff_source_cf_date

, qf.ff_sales
, qf.ff_net_income
, qf.ff_com_shs_out_eps_basic
, qf.ff_com_shs_out_eps_dil
, qf.ff_com_shs_out
, qf.ff_eps_reported
, qf.ff_eps_basic



from fp_v2.fp_basic_prices p

left join lag on lag.date = p.p_date and p.fsym_id = lag.fsym_id
left join ff_v3.ff_basic_qf as qf ON qf.date = LAG.date and lag.fsym_id = qf.fsym_id

where p.p_date between '2015-09-30' and '2020-12-31' --and ticker_region is not null
and p.fsym_id in ('C46GQC-R','XLY63V-R','CZ9VBX-R','LY653H-R','VLHKF9-R') --,'SHNDLT-R','C4HBRT-R','HN195G-R','KB2QBM-R','FWJSXX-R','DJC2TN-R','HP58X9-R','RT66YK-R','V1H7QF-R','JT71M6-R','FWHC5K-R','BV8JHF-R','FLF3SM-R','PX1NYT-R','KDJSF0-R','DMRWLY-R','B8374S-R','NT37R4-R','TF1DZP-R','DDZB0B-R','NDN5DT-R','KK1SFD-R','BYJYYM-R','WFJYTJ-R','HTM0LK-R','NT45J0-R','PN6Y00-R','MCNYYL-R','GRSDSK-R','CSFJSZ-R','D502G9-R','MVLTQZ-R','VS59M7-R','DTKPJP-R','CFG1CD-R','BK2FRW-R','SKZRLQ-R','TMTGLT-R','CYB1M0-R','V2H5QG-R','HGBJ0K-R','F17SJ1-R','MH3TRW-R','CN7T72-R','VT66G5-R','DMX4QY-R','CYC4Q1-R','MH33D6-R','M0H6M5-R','MQ119X-R','TNZ6CZ-R','PTRY1F-R','FT7VMB-R','JXMLY8-R','TY202Q-R','PJTSGB-R','JDQ0K1-R','KMBRT0-R','KDJL0T-R','NFMH78-R','VFT0VQ-R','DTKZ1Y-R','DF9PT2-R','JBG9LM-R','Q7WZWY-R','TVTFDF-R','WFLMHL-R','D54BL9-R','QLRPKF-R','DBNXVB-R','WPKF66-R','X8L2PH-R','HF5SX1-R','RPNJRM-R','LQ7KY5-R','RXHN9P-R','LC0H1H-R','HF1P15-R','MS9FKZ-R','VR16P9-R','NMGMBX-R','L8SKLT-R','J2MLPV-R','MXZ7RW-R','B81TLL-R','LX237L-R','G3949H-R','S26JJL-R','RTXD8D-R','D1P43P-R','FMDS8D-R','LTN366-R','GGPDYX-R','D68983-R','LTP0Z2-R','P4VXRX-R','JJ7V03-R','JTC04X-R','BLB2G4-R','DHC1MJ-R','WM5BXP-R','X1SCTR-R','KL1DV4-R','KZKK3D-R','LD0WYZ-R','FYT41X-R','QCYLZB-R','HNZVK6-R','RYTJNF-R','FVD6P4-R','PY5KHK-R','QP3LLV-R','R6WVW3-R','LTSNXH-R','FV824M-R','K24Q4R-R','M7439D-R','F1B8CH-R','H8JXH0-R','WPFS7S-R','KFQHFG-R','R81DNG-R','SHRZF5-R','T2ZH1Y-R','PKY50L-R','GFJC62-R','F07Q7W-R','RK3DL5-R','WDG05S-R','NW728X-R','CJVKH9-R','CYB6Y5-R','NT38T5-R','H1PMLS-R','BQ7YD0-R','JMNLQC-R','RJ022Y-R','DJC60R-R','PRGN6N-R','TWXW2R-R','X0N4MP-R','RK3HS8-R','T7H5H1-R','DJBQ39-R','K24537-R','NHV4Q7-R','BL5KVX-R','XNRMXZ-R','C8WF4C-R','CPCW2Z-R','BYNP13-R','W6N4JC-R','B4PGFJ-R','GRMY8C-R','GRS9LG-R','FQYW7Q-R','J70ZTV-R','DGBZCC-R','N4P9L4-R','G8WDMZ-R','BNJBN6-R','GGPTR9-R','H69CWS-R','RBJXH6-R','MPXJMM-R','PJNB5B-R','B71DJZ-R','KYKCS8-R','TTHJD1-R','BDQDB8-R','MR0PSP-R','NXHLP0-R','F05QG0-R','V75BKP-R','C7C9TP-R','F96XVZ-R','DH7WLK-R','BPRHF0-R','TY1SPJ-R','VQXR21-R','FYMJCN-R','QHBXV5-R','JFW9S3-R','CJTQXJ-R','GQGQ5C-R','W6SXMV-R','FJ4J4C-R','NZMV05-R','QWV5DL-R','TNZ1G6-R','DG27Q5-R','RK8Z6D-R','DSBCFQ-R','PN37ZK-R','V9977J-R','QJ9QP4-R','X9Q3HC-R','PVBYXV-R','B83YJG-R','MVKZ35-R','NPK3PS-R','FCK6QT-R','PVWPB1-R','B5TG5C-R','XD67LR-R','QG1HR7-R','TWS77D-R','BCD4JF-R','G26K3V-R','QLGSL2-R','FS32CR-R','FDS1XB-R','MH7TCM-R','JJ39BV-R','RGTY61-R','LRK013-R','GYM5PB-R','D0QHLW-R','QLQKDC-R','BV4P4T-R','WGXV7D-R','Q774MW-R','VYQ02C-R','MYZ7WZ-R','XLV24X-R','CL1QH9-R','P1P032-R','BWZ93Y-R','HLX79K-R','LPRN3T-R','M8XT6B-R','HMVVTC-R','B3DVXC-R','DG71WP-R','QR56YK-R','FJ1B1C-R','Q53D75-R','R5RD6T-R','T67DJN-R','LTP334-R','CTYNJ1-R','R5XGXL-R','T0SQZH-R','SJS2RC-R','JYWMBW-R','KK1YRK-R','QJBZ19-R','JLJ0VZ-R','D8FPTC-R','DRBC9M-R','NKGZ7J-R','MS57L1-R','GN6KCJ-R','H0P6P9-R','P5BP94-R','PHJ2V4-R','P31DB7-R','H7DGWR-R','T3YH93-R','D3ZY22-R','KW432H-R','MJCGG4-R','Q78D01-R','F9VYPD-R','MFQVZQ-R','KSWML9-R','BQR5YT-R','PD98GG-R','WGLQTS-R','CYBC69-R','HJG212-R','L32LM8-R','PZ917X-R','CHK9QJ-R','G7VZQH-R','HJXXH4-R','VR4SHN-R','KFJFWS-R','NFMPMG-R','RRXTTL-R','HXZ458-R','LD13C5-R','C0YGQ6-R','HZ6Z7Q-R','JKGP5M-R','SJY281-R','NV7K28-R','GZF20K-R','PVW48J-R','L6CPTK-R','NBCKRK-R','XKBMRH-R','LVYTWF-R','NNKD2Y-R','JKDM7P-R','NQTR8Z-R','KV0J41-R','N6Z3ML-R','X59HZ5-R','CZBYFY-R','DG6SCF-R','JPTF52-R','JFVMGG-R','BT4P4V-R','MG2TQV-R','FXTG1M-R','BQWWY7-R','VDPDV7-R','XM8P7T-R','GJZ5YB-R','Q4YP8S-R','R2J99W-R','FBCHQC-R','JZWRR3-R','KMBPNY-R','KYCY91-R','C7M7DL-R','RT2ZSJ-R','W8YRN3-R','VBN9H0-R','KFMMZS-R','QZ3ZG1-R','D1RCCS-R','L7LP86-R','FH1NKL-R','CC0SQN-R','B19ST9-R','LBWNRX-R','H68NH2-R','MLQ41B-R','KC6WDM-R','VBK29Z-R','CHKL7S-R','X8LB4Q-R','M79B89-R','MKJ8WW-R','L6BT3Q-R','BV3N5V-R','QMQV1Q-R','JRFYNM-R','S4J8BX-R','XHD46K-R','K38HHD-R','V6ZQWF-R','HSF35X-R','LQBB5R-R','M4VLV7-R','F72PJT-R','NW8BQ3-R','VTBLV9-R','NYJHHY-R','CN4ZZK-R','M79R1P-R','NPJW7K-R','PHPSQH-R','P8R3C2-R','V5WMVF-R','CHR1NX-R','JWH12W-R','RGZN5G-R','NCL5GV-R','HHB3C8-R','B4PMRP-R','NNFR4J-R','MDYC2K-R','CY644B-R','VWGLQ7-R','MMRZQ5-R','XQCN4R-R','RVC5J9-R','D0LDT1-R','WFMVVR-R','VBL38Y-R','J2LVSN-R','LLZBW5-R','JFW5HZ-R','C4C0BL-R','GFJGD5-R','GC4MKW-R','CGGG4R-R','KTPK4Q-R','FQJDL3-R','KB3YPS-R','VNMTTH-R','RYRC40-R','M9DGHF-R','FPP9SL-R','KDCD3Y-R','X1RJ5Y-R','LHKN8Z-R','KDHCQP-R','HKLJPC-R','K7TPSX-R','K5JXTH-R','P36M94-R','R998SY-R','T6CPQP-R','D8D820-R','NGW97P-R','HQ4DBK-R','RCNCKX-R','C5CPSB-R','PY50G1-R','HSFL3C-R','RPTY1P-R','XKPH9J-R','J70N5J-R','FZRL7K-R','VDT85V-R','NFRN55-R','FBB432-R','V3Q5PM-R','RQ9F5S-R','B4L66G-R','PKZ3VH-R','PPCTFP-R','Q3VTNZ-R','VK7M4R-R','KRQTDT-R','TTDQ0D-R','C8XJ7D-R','TKKPJB-R','DNY1KW-R','FPP2BC-R','B6V0BZ-R','N18P40-R','VNRDMV-R','DXZQS6-R','RZXDWV-R','HVV49B-R','B97MP0-R','SHNVG7-R','KYJFW8-R','C46DK8-R','F1DFCD-R','M8867B-R','FXH4XG-R','S7P87W-R','KHX8Q2-R','RJ0FT9-R','T0JL9Q-R','F1DNTM-R','MMN39J-R','MKC1SV-R','B6ZXQL-R','TJG1FT-R','BZPFLX-R','S8ZQDV-R','FDS65G-R','NPK7YX-R','J2MW73-R','V3MK5N-R','D3VZJC-R','R4M2WP-R','Q78KB6-R','WRVHRX-R','FQZF97-R','FJ4NDH-R','JJ81D9-R','PRGQ6L-R','XKT8J2-R','G5M19V-R','K8YRNT-R','BV8GCC-R','GZMRSV-R','R3J43T-R','CGLRBS-R','RQXL78-R','BJ2HRV-R','KM5Q58-R','WYCPCP-R','RXG6KB-R','WQK5W2-R','MJ0XB7-R','GC9695-R','M1H0C2-R','DXVDJ4-R','VFY8ZQ-R','FPTJVK-R','DXW84Y-R','XGFDHN-R','BFSY5M-R','XKPF5G-R','WRYB4K-R','LKPWM4-R','GM32M5-R','TWTDGH-R','SQGY1B-R','JQZ00G-R','HVQ2KJ-R','TY1WWM-R','S48YD1-R','CPCV0Y-R','VQYTRP-R','T2TNWF-R','KCCLD1-R','S8ZPBT-R','W5QQ9P-R','MYW502-R','LN3P8B-R','J994MP-R','JS6B3F-R','MTGSY3-R','M0C1P8-R','P9ZMV7-R','DF2WYT-R','G4GB6B-R','HQ87P5-R','GN6RRQ-R','BK6JKQ-R','FT8DNV-R','G90MPY-R','QCS6P8-R','KRTZ9N-R','R3HBM2-R','BRWKF0-R','Q8G78M-R','FS319Q-R','TB9J64-R','GX5LJC-R','LKST5W-R','KZMN3C-R','S9NVWV-R','RT7HCR-R','BM9QXX-R','KFP2R4-R','WYJT0C-R','GM3DBL-R','N2GNNQ-R','VBCQMG-R','M1FW60-R','QKJS7V-R','KPFMHW-R','W0Z4W6-R','GGPVTB-R','XMYTFJ-R','PKZ95N-R','XKTZWR-R','NV79M1-R','H2VPCM-R','VR1F2H-R','THB4X2-R','NB76FG-R','FT8FQW-R','M67VFY-R','FFQNC3-R','S7RV59-R','K6RW63-R','LZBPWV-R','LC1BTF-R','PVG5TM-R','RDKCLT-R','MQ0Y3T-R','RFPMVX-R','XF43NV-R','CSMTMQ-R','SDDH43-R','TZ2TSL-R','WL1GCY-R','X47RHF-R','VWF970-R','B6ZP8C-R','S8Z499-R','W00MKH-R','J9F59G-R','HP13ZD-R','DLSMXK-R','DH79H0-R','J2NPSW-R','QSDQCP-R','RBDXWG-R','JCPT0R-R','KB791X-R','JMHSJV-R','RSQN90-R','H679XT-R','VCNXSP-R','F82H8Q-R','LJQYJ1-R','CRP3ZV-R','TW6KKV-R','WW7DBW-R','RJVBBR-R','R71MZL-R','HQ2MHF-R','PY5NPN-R','BWDZ2P-R','WTJ15D-R','MH2KBP-R','SZJL5M-R','V05L58-R','GZKHGQ-R','JYRG0L-R','GS3RJ8-R','VT4SWZ-R','LQ766T-R','CWRF0J-R','J89J6Y-R','MZJHY9-R','FR4YZK-R','W0731Q-R','KXDMGL-R','CRHPMR-R','QD8WKZ-R','SPGL7X-R','RMFR2L-R','C5GXYC-R','RJ3WCJ-R','MBK7R0-R','H53QZC-R','JPXNB3-R','JMHYW0-R','FPPSQ1-R','T1N9NF-R','RZQS4K-R','GRQMJ0-R','XLT03X-R'))
order by p.p_date
